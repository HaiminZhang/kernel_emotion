%%
%%

function TPM_test()
    clc;clear all;
    rng(2000);  %2300
    para_cost = 1;  % Cost parameter
     
    nRounds = 20;
    tr_num = 60;
    
    mem_block = 3000;
    addpath('Liblinear/matlab');
    
%     load('dictionary/Cluster_CNN.mat');
%     nCodebook = size(Cluster_CNN, 2);
%     clear DEEP_CodeBook_1024;
%     pyramid = [1];
%     dFea = sum(nCodebook * pyramid);
    dFea = 1024*2;
    %meanfea = [0.010048, 0.005474, 0.019640, 0.006092, 0.012272, 0.006961, 0.006349, 0.016514, 0.007083, 0.011621, 0.011193, 0.013306, 0.005411, 0.005604, 0.009772, 0.009331, 0.008720, 0.018142, 0.005245, 0.015467, 0.010571, 0.013760, 0.009315, 0.009069, 0.011724, 0.012388, 0.004522, 0.008147, 0.004941, 0.008429, 0.015214, 0.005694, 0.009725, 0.017433, 0.017776, 0.012340, 0.011294, 0.008563, 0.004453, 0.025421, 0.012819, 0.004937, 0.006663, 0.013293, 0.009082, 0.007725, 0.004676, 0.009466, 0.008682, 0.005855, 0.004491, 0.011877, 0.013362, 0.006924, 0.009056, 0.006843, 0.007431, 0.007332, 0.013437, 0.016155, 0.009208, 0.007861, 0.006533, 0.003892, 0.020802, 0.009026, 0.005543, 0.015935, 0.007449, 0.008692, 0.021109, 0.011395, 0.014758, 0.017691, 0.007750, 0.003998, 0.013892, 0.012100, 0.005249, 0.009697, 0.004679, 0.004544, 0.010989, 0.010362, 0.006041, 0.007825, 0.006780, 0.008289, 0.013917, 0.007385, 0.004359, 0.008936, 0.009807, 0.004613, 0.006830, 0.010945, 0.008527, 0.008446, 0.016759, 0.007232, 0.007159, 0.009267, 0.007616, 0.010554, 0.006636, 0.009704, 0.014486, 0.007249, 0.009734, 0.015039, 0.021204, 0.008076, 0.011247, 0.011108, 0.009527, 0.006003, 0.007943, 0.006284, 0.010337, 0.005591, 0.011301, 0.006410, 0.004356, 0.013395, 0.024120, 0.008641, 0.011411, 0.004064, 0.012300, 0.024466, 0.005912, 0.011957, 0.008014, 0.023310, 0.014238, 0.007359, 0.008039, 0.023496, 0.006348, 0.004380, 0.004438, 0.005577, 0.007310, 0.006245, 0.015722, 0.013798, 0.009774, 0.011875, 0.019741, 0.016648, 0.005729, 0.008367, 0.018433, 0.012191, 0.010114, 0.015178, 0.008832, 0.005073, 0.024113, 0.020977, 0.012912, 0.008719, 0.005576, 0.013696, 0.008612, 0.006282, 0.020985, 0.006859, 0.010665, 0.016248, 0.009930, 0.036418, 0.033255, 0.005693, 0.005222, 0.006920, 0.006832, 0.008718, 0.006891, 0.007770, 0.004269, 0.012886, 0.009302, 0.005639, 0.009813, 0.007068, 0.007138, 0.004098, 0.013982, 0.006150, 0.004972, 0.010544, 0.012964, 0.007982, 0.009144, 0.010973, 0.018372, 0.006551, 0.007043, 0.005791, 0.007622, 0.003835, 0.022175, 0.023584, 0.005548, 0.009365, 0.005268, 0.020971, 0.004367, 0.019375, 0.010993, 0.012223, 0.011350, 0.007332, 0.007129, 0.016763, 0.015846, 0.002735, 0.006107, 0.011182, 0.008368, 0.009635, 0.005825, 0.006627, 0.010855, 0.005350, 0.007420, 0.008162, 0.006571, 0.011776, 0.009127, 0.005281, 0.009588, 0.008738, 0.007079, 0.007989, 0.012612, 0.007908, 0.005239, 0.011243, 0.004796, 0.008715, 0.005637, 0.020761, 0.010128, 0.026673, 0.004285, 0.006551, 0.008475, 0.012137, 0.007212, 0.008338, 0.009745, 0.029670, 0.015054, 0.008740, 0.004656, 0.005075, 0.010725, 0.006669, 0.014489, 0.004594, 0.033257, 0.014932, 0.006046, 0.008002, 0.011399, 0.013936, 0.020003, 0.011670, 0.009518, 0.005999, 0.007752, 0.015472, 0.007686, 0.007457, 0.029728, 0.008019, 0.005907, 0.010620, 0.021297, 0.010471, 0.005239, 0.034315, 0.004386, 0.004665, 0.008553, 0.006911, 0.004115, 0.017369, 0.009622, 0.005554, 0.007622, 0.010231, 0.006325, 0.011971, 0.007724, 0.018525, 0.018589, 0.010310, 0.012923, 0.005249, 0.005702, 0.008564, 0.005415, 0.018165, 0.013159, 0.007809, 0.004831, 0.034103, 0.016286, 0.007810, 0.007308, 0.026751, 0.007384, 0.016763, 0.008535, 0.028958, 0.008443, 0.006551, 0.017377, 0.007796, 0.004596, 0.011373, 0.010319, 0.017011, 0.016437, 0.005254, 0.017302, 0.004885, 0.006161, 0.008239, 0.017774, 0.009361, 0.031127, 0.003406, 0.021355, 0.004185, 0.008656, 0.013879, 0.009415, 0.006447, 0.010712, 0.006843, 0.006811, 0.003711, 0.010483, 0.009020, 0.032840, 0.008891, 0.008534, 0.006719, 0.009991, 0.008846, 0.023430, 0.005161, 0.008277, 0.007850, 0.006092, 0.007019, 0.012637, 0.011078, 0.009467, 0.007895, 0.010906, 0.004539, 0.020089, 0.017301, 0.006520, 0.006017, 0.006696, 0.007054, 0.007150, 0.011483, 0.010407, 0.006518, 0.004340, 0.006520, 0.010212, 0.009514, 0.011480, 0.010178, 0.009922, 0.020062, 0.007762, 0.005861, 0.005332, 0.009797, 0.011060, 0.010203, 0.010617, 0.008309, 0.017973, 0.014483, 0.006780, 0.006777, 0.010861, 0.005014, 0.007307, 0.017116, 0.014248, 0.005587, 0.004846, 0.010746, 0.007884, 0.011788, 0.007622, 0.006918, 0.022761, 0.008666, 0.010360, 0.005003, 0.004277, 0.012507, 0.007714, 0.008643, 0.005661, 0.007842, 0.007058, 0.011554, 0.007201, 0.004868, 0.010258, 0.033463, 0.020445, 0.009301, 0.010691, 0.005889, 0.010703, 0.022833, 0.005874, 0.016033, 0.046359, 0.010577, 0.014921, 0.009371, 0.020588, 0.007362, 0.036461, 0.009149, 0.014160, 0.010043, 0.005107, 0.006312, 0.011495, 0.005286, 0.004958, 0.005263, 0.010647, 0.017622, 0.008411, 0.007166, 0.008171, 0.024541, 0.007834, 0.007975, 0.022042, 0.012396, 0.009006, 0.005764, 0.012889, 0.005717, 0.030663, 0.017269, 0.004627, 0.017689, 0.012587, 0.008241, 0.008867, 0.020465, 0.007594, 0.005764, 0.009608, 0.005732, 0.006425, 0.004538, 0.007807, 0.018356, 0.012803, 0.013260, 0.007379, 0.009078, 0.018234, 0.019429, 0.011436, 0.009916, 0.008627, 0.024870, 0.012527, 0.009481, 0.005626, 0.007934, 0.003579, 0.008268, 0.007315, 0.011253, 0.010623, 0.005485, 0.011391, 0.011264, 0.013374, 0.011155, 0.013678, 0.005017, 0.011652, 0.010265, 0.007438, 0.013603, 0.009546, 0.005724, 0.008326, 0.009716, 0.010084, 0.004185, 0.010657, 0.010793, 0.011369, 0.004098, 0.012631, 0.008875, 0.008851, 0.012686, 0.025295, 0.005489, 0.005742, 0.011296, 0.007359, 0.009984, 0.008188, 0.007852, 0.017720, 0.010771, 0.007496, 0.025286, 0.008129, 0.010403, 0.009917, 0.012243, 0.011760, 0.009480, 0.006088, 0.006594, 0.014470, 0.008780, 0.015594, 0.009616, 0.032452, 0.025270, 0.008163, 0.002678, 0.028835, 0.006080, 0.010862, 0.007071, 0.010833, 0.004854, 0.006973, 0.009287, 0.009336, 0.009539, 0.014371, 0.014819, 0.003790, 0.005598, 0.023556, 0.010794, 0.014541, 0.010961, 0.007083, 0.008747, 0.007826, 0.008421, 0.010714, 0.011300, 0.013489, 0.022776, 0.027152, 0.012855, 0.006189, 0.007166, 0.010562, 0.010437, 0.007564, 0.008887, 0.005736, 0.006427, 0.013922, 0.011153, 0.006906, 0.015156, 0.009465, 0.007645, 0.013594, 0.015654, 0.004563, 0.011460, 0.009780, 0.016212, 0.012657, 0.012954, 0.028444, 0.010689, 0.011778, 0.006085, 0.014657, 0.027791, 0.012564, 0.005058, 0.019125, 0.006424, 0.009896, 0.009783, 0.005516, 0.017482, 0.011438, 0.016625, 0.005775, 0.023284, 0.005621, 0.007956, 0.006406, 0.014680, 0.006581, 0.005920, 0.015509, 0.005971, 0.011513, 0.025993, 0.008639, 0.003877, 0.010052, 0.013652, 0.012520, 0.012964, 0.005896, 0.012317, 0.011165, 0.010035, 0.004020, 0.005371, 0.007307, 0.010042, 0.021195, 0.009400, 0.004331, 0.004716, 0.005035, 0.008699, 0.008792, 0.005977, 0.008779, 0.011039, 0.006801, 0.013332, 0.008496, 0.004745, 0.007482, 0.008653, 0.005018, 0.010617, 0.006277, 0.006639, 0.006751, 0.007698, 0.009988, 0.009258, 0.009129, 0.005420, 0.006592, 0.008342, 0.004381, 0.006655, 0.009655, 0.028888, 0.006345, 0.013237, 0.009576, 0.007949, 0.011105, 0.020418, 0.017256, 0.010426, 0.008627, 0.011115, 0.008480, 0.008950, 0.008069, 0.009542, 0.013289, 0.006819, 0.013185, 0.006153, 0.008399, 0.025954, 0.007822, 0.007325, 0.013426, 0.006800, 0.005910, 0.008915, 0.015324, 0.009991, 0.010944, 0.009915, 0.006912, 0.010915, 0.021407, 0.009540, 0.015976, 0.005806, 0.010471, 0.007118, 0.012856, 0.008572, 0.004649, 0.014590, 0.007931, 0.014670, 0.009847, 0.010965, 0.007347, 0.010458, 0.009581, 0.004768, 0.007818, 0.007163, 0.007813, 0.007724, 0.004944, 0.008317, 0.010409, 0.008538, 0.009406, 0.008705, 0.006879, 0.010408, 0.004387, 0.007259, 0.006490, 0.003356, 0.009175, 0.010288, 0.009026, 0.006478, 0.006666, 0.005900, 0.017183, 0.015018, 0.019155, 0.004772, 0.003559, 0.011280, 0.005615, 0.015664, 0.007040, 0.005550, 0.017349, 0.014686, 0.008610, 0.011195, 0.007441, 0.009456, 0.007018, 0.013639, 0.010925, 0.011941, 0.007203, 0.008144, 0.007560, 0.008884, 0.012204, 0.005939, 0.003835, 0.005926, 0.010239, 0.016639, 0.007526, 0.009456, 0.007673, 0.012109, 0.003131, 0.013889, 0.010687, 0.017615, 0.004946, 0.020510, 0.009830, 0.007717, 0.009051, 0.014065, 0.010414, 0.010195, 0.006745, 0.013309, 0.009980, 0.011004, 0.010372, 0.011257, 0.014154, 0.006202, 0.017922, 0.012112, 0.007780, 0.016303, 0.029735, 0.010580, 0.007083, 0.010693, 0.011622, 0.014458, 0.011348, 0.010560, 0.009772, 0.009899, 0.006517, 0.012629, 0.005884, 0.007760, 0.017348, 0.006964, 0.008469, 0.014627, 0.007925, 0.007661, 0.007851, 0.010828, 0.012235, 0.005171, 0.023950, 0.012465, 0.012634, 0.003655, 0.008212, 0.007129, 0.009151, 0.006285, 0.014578, 0.006912, 0.008152, 0.010984, 0.019467, 0.006335, 0.008497, 0.008611, 0.008050, 0.005126, 0.014632, 0.006087, 0.011525, 0.010008, 0.019181, 0.020925, 0.011745, 0.024857, 0.017217, 0.030590, 0.007312, 0.004987, 0.007912, 0.007462, 0.011485, 0.012261, 0.006782, 0.008836, 0.011838, 0.008941, 0.008927, 0.021646, 0.007127, 0.006037, 0.012870, 0.011204, 0.008595, 0.003683, 0.006432, 0.009958, 0.010701, 0.008703, 0.008035, 0.006778, 0.009356, 0.003803, 0.008239, 0.022851, 0.004697, 0.009895, 0.011033, 0.007484, 0.005058, 0.013715, 0.005493, 0.011078, 0.012873, 0.008235, 0.004481, 0.004901, 0.009202, 0.007091, 0.012007, 0.006031, 0.008501, 0.010415, 0.010059, 0.006561, 0.016328, 0.014357, 0.016632, 0.014847, 0.016428, 0.008211, 0.007508, 0.029479, 0.006197, 0.009926, 0.006146, 0.009536, 0.007465, 0.004486, 0.005750, 0.010977, 0.011834, 0.005791, 0.007116, 0.004133, 0.007674, 0.012901, 0.013025, 0.004188, 0.018560, 0.009114, 0.008915, 0.008430, 0.010493, 0.026777, 0.010280, 0.007546, 0.007421, 0.007369, 0.010607, 0.014809, 0.015809, 0.007191, 0.008017, 0.007440, 0.012556, 0.012602, 0.010780, 0.009926, 0.017002, 0.006881, 0.007571, 0.009189, 0.004656, 0.006898, 0.004457, 0.026302, 0.009251, 0.006041, 0.017127, 0.012711, 0.014072, 0.011795, 0.008625, 0.008034, 0.008993, 0.011439, 0.016638, 0.011950, 0.017146, 0.022462, 0.007728, 0.030577, 0.013669, 0.007374, 0.005873, 0.007303, 0.014193, 0.025239, 0.026038, 0.006764, 0.012205, 0.026517, 0.024424, 0.009642, 0.007944, 0.008142, 0.014608, 0.008284, 0.007949, 0.013004, 0.011112, 0.017663, 0.034891, 0.025578, 0.005765, 0.014166, 0.014986, 0.006882, 0.006380, 0.005215, 0.010156, 0.009859, 0.007630, 0.018286, 0.019173, 0.019770, 0.014019, 0.023597, 0.013648, 0.006554, 0.008697, 0.007642, 0.015033, 0.012559, 0.007709, 0.011414, 0.011079, 0.009479, 0.005815, 0.017180, 0.015729, 0.014532, 0.007689, 0.008483, 0.007916, 0.008071, 0.012997, 0.004987, 0.013663, 0.009716, 0.010728, 0.007638, 0.010691, 0.025676, 0.005735, 0.013020, 0.006435, 0.007559, 0.004611, 0.009932, 0.014771, 0.016249, 0.004631, 0.010506, 0.005284, 0.010135, 0.007660, 0.006251, 0.006151, 0.005334, 0.026117, 0.005758, 0.006491, 0.005730, 0.015370, 0.007091, 0.014769, 0.021844, 0.005621, 0.003072, 0.022138, 0.017026, 0.011033, 0.008791, 0.008616, 0.015641, 0.007248, 0.003313, 0.013032, 0.008247, 0.029191, 0.012317, 0.006809, 0.008974, 0.005270, 0.006135, 0.013168, 0.011171, 0.009041, 0.022393, 0.005675, 0.014811, 0.010474, 0.008568, 0.005388, 0.010146, 0.008841, 0.027450, 0.009288, 0.014409, 0.002933, 0.005449, 0.007304, 0.003397, 0.008517, 0.016919, 0.007869, 0.007883, 0.009564, 0.009352, 0.006508, 0.010951, 0.015339, 0.006755, 0.011410, 0.010271, 0.011646, 0.010807, 0.015174, 0.007662, 0.016235, 0.004748, 0.010124, 0.006700, 0.014458, 0.011504, 0.009765, 0.007927, 0.006629, 0.008220, 0.022483, 0.006693, 0.004691, 0.006376, 0.007738, 0.013162, 0.011914, 0.008405, 0.010347, 0.009629, 0.004821, 0.011755, 0.010301, 0.020585, 0.010992, 0.008974, 0.004320, 0.014371, 0.010232, 0.008695, 0.017500, 0.010840, 0.006668, 0.026239, 0.010464, 0.017899, 0.006816, 0.036007, 0.009729, 0.020526, 0.009453, 0.009454, 0.007749, 0.012284, 0.009186, 0.004486, 0.008810, 0.009838, 0.012865, 0.009410, 0.004947, 0.008347, 0.009523, 0.014103, 0.006067, 0.004856, 0.006683, 0.015363, 0.007794, 0.012304, 0.006340, 0.005581, 0.011045, 0.010075, 0.007654, 0.005891, 0.005596, 0.005447, 0.008110, 0.005056, 0.005408, 0.009908, 0.006781, 0.010346, 0.009460, 0.025888, 0.012295, 0.022701, 0.011487, 0.011298, 0.007803, 0.009877, 0.009475, 0.006204, 0.016665, 0.007238, 0.007350, 0.007099, 0.012582, 0.013760, 0.013498, 0.009389, 0.021337, 0.009567, 0.005840, 0.018539, 0.010096, 0.008075, 0.006993, 0.020952, 0.005088, 0.014410, 0.017984, 0.009339, 0.007291, 0.005535, 0.008411, 0.009127, 0.008374, 0.006341, 0.009013, 0.006600, 0.007895, 0.012951, 0.042567, 0.024410, 0.005605, 0.020006, 0.006921, 0.008207, 0.012858, 0.029377, 0.013922, 0.008749, 0.006091, 0.008226, 0.006927, 0.008876, 0.005080, 0.010330, 0.007692, 0.004280, 0.020645, 0.009555, 0.015672, 0.016431, 0.019355, 0.003959, 0.004690, 0.006890, 0.010533, 0.006486, 0.010148, 0.054771, 0.041470, 0.008305, 0.006541, 0.008138, 0.008866, 0.004490, 0.007116, 0.010615, 0.012009, 0.011394, 0.010877, 0.011090, 0.007470, 0.013294, 0.007712, 0.010619, 0.008851, 0.010061, 0.006820, 0.011099, 0.034897, 0.005500, 0.016769, 0.008728, 0.006304, 0.007331, 0.005423, 0.007629, 0.007812, 0.015055, 0.008575, 0.006760, 0.012045, 0.011721, 0.013933, 0.010214, 0.007722, 0.005903, 0.012424, 0.006594, 0.010691, 0.006428, 0.006014, 0.005932, 0.009192, 0.051537, 0.007843, 0.015946, 0.006387, 0.012790, 0.006961, 0.006034, 0.007537, 0.004599, 0.010537, 0.018898, 0.014190, 0.003393, 0.005793, 0.009601, 0.007828, 0.012944, 0.009219, 0.007103, 0.008115, 0.008293, 0.007471, 0.005234, 0.010927, 0.011074, 0.007999, 0.009296, 0.013971, 0.006306, 0.007767, 0.015665, 0.004584, 0.011661, 0.008251, 0.005432, 0.013955, 0.004823, 0.011937, 0.007459, 0.019821, 0.003416, 0.016178, 0.012124, 0.011381, 0.009071, 0.038896, 0.010820, 0.008234, 0.008226, 0.017919, 0.007505, 0.005810, 0.006213, 0.011095, 0.014632, 0.009986, 0.004377, 0.026709, 0.004167, 0.005662, 0.006700, 0.004986, 0.008624, 0.005497, 0.006965, 0.021044, 0.004025, 0.007215, 0.004812, 0.005301, 0.005752, 0.003988, 0.010743, 0.008390, 0.007646, 0.033446, 0.007721, 0.006926, 0.008544, 0.010730, 0.005023, 0.005310, 0.007551, 0.020089, 0.007817, 0.014528, 0.005126, 0.004078, 0.013132, 0.006821, 0.016128, 0.016983, 0.005326, 0.010835, 0.002051, 0.009215, 0.006458, 0.009036, 0.010001, 0.014424, 0.017081, 0.009086, 0.009814, 0.012049, 0.007514, 0.013251, 0.004385, 0.009907, 0.014844, 0.004361, 0.010422, 0.012068, 0.010982, 0.012591, 0.010001, 0.011187, 0.007136, 0.005142, 0.009759, 0.012569, 0.006118, 0.009152, 0.007925, 0.009027, 0.009457, 0.008209, 0.014494, 0.010742, 0.006744, 0.011300, 0.007986, 0.024346, 0.014464, 0.013136, 0.011618, 0.012472, 0.010445, 0.004847, 0.016919, 0.011587, 0.005464, 0.009139, 0.007990, 0.021439, 0.006578, 0.007961, 0.009425, 0.007297, 0.013936, 0.025572, 0.009920, 0.023109, 0.019582, 0.007199, 0.009221, 0.007458, 0.007145, 0.005756, 0.023741, 0.005216, 0.009323, 0.007922, 0.016170, 0.010143, 0.009952, 0.004817, 0.006585, 0.010031, 0.013960, 0.012383, 0.008628, 0.010973, 0.009406, 0.007408, 0.018893, 0.009465, 0.006719, 0.012463, 0.011176, 0.011568, 0.012520, 0.011577, 0.005183, 0.009418, 0.009933, 0.099799, 0.009377, 0.009759, 0.004417, 0.009116, 0.003741, 0.007638, 0.011959, 0.013852, 0.017331, 0.014597, 0.008867, 0.005073, 0.004964, 0.008757, 0.010571, 0.014614, 0.021889, 0.028265, 0.008686, 0.032830, 0.005108, 0.010904, 0.009513, 0.009241, 0.007062, 0.010442, 0.003538, 0.009917, 0.016245, 0.014492, 0.005613, 0.006307, 0.003163, 0.010125, 0.018609, 0.003198, 0.011346, 0.006403, 0.034848, 0.004918, 0.010905, 0.017000, 0.008266, 0.020181, 0.015931, 0.004238, 0.015013, 0.006706, 0.007620, 0.009686, 0.013359, 0.016224, 0.013285, 0.006366, 0.013062, 0.009262, 0.010568, 0.006935, 0.006863, 0.006866, 0.022277, 0.007215, 0.007494, 0.041732, 0.006520, 0.009329, 0.007995, 0.021527, 0.007507, 0.006870, 0.005033, 0.004540, 0.006978, 0.013519, 0.008488, 0.009688, 0.007701, 0.009733, 0.005227, 0.005510, 0.013520, 0.008196, 0.012758, 0.014638, 0.008642, 0.011819, 0.008490, 0.021600, 0.005698, 0.006775, 0.017693, 0.006650, 0.012656, 0.006540, 0.030414, 0.009452, 0.011795, 0.018177, 0.010429, 0.009439, 0.015512, 0.005841, 0.006446, 0.006639, 0.015787, 0.004657, 0.009981, 0.018518, 0.006522, 0.006562, 0.013264, 0.014664, 0.010318, 0.010571, 0.011234, 0.009763, 0.005865, 0.005910, 0.006736, 0.009265, 0.006914, 0.010593, 0.006829, 0.022259, 0.023994, 0.012697, 0.007270, 0.010788, 0.009468, 0.004715, 0.006201, 0.005701, 0.012133, 0.006867, 0.015746, 0.021872, 0.008674, 0.011256, 0.006918, 0.020649, 0.007430, 0.009180, 0.010977, 0.005668, 0.007520, 0.012928, 0.007841, 0.007997, 0.011047, 0.007158, 0.003724, 0.008479, 0.011903, 0.011820, 0.006742, 0.005485, 0.005565, 0.010634, 0.007146, 0.006910, 0.017912, 0.008492, 0.015053, 0.006204, 0.019777, 0.008237, 0.018018, 0.008620, 0.002992, 0.020774, 0.005784, 0.020014, 0.014167, 0.011346, 0.006788, 0.008244, 0.006374, 0.006548, 0.005355, 0.005071, 0.011478, 0.021513, 0.017155, 0.006071, 0.005491, 0.006094, 0.005881, 0.008113, 0.008998, 0.007234, 0.016422, 0.008005, 0.004766, 0.010000, 0.017547, 0.013001, 0.013609, 0.009857, 0.018181, 0.027018, 0.006414, 0.005955, 0.007587, 0.013713, 0.005615, 0.008517, 0.016349, 0.009335, 0.013301, 0.004076, 0.009190, 0.012298, 0.006476, 0.008096, 0.014947, 0.008957, 0.020226, 0.012908, 0.016541, 0.009396, 0.007121, 0.009681, 0.007256, 0.017808, 0.015251, 0.008473, 0.014758, 0.012333, 0.005942, 0.006387, 0.017090, 0.007537, 0.008610, 0.010981, 0.008136, 0.009923, 0.006196, 0.008080, 0.009759, 0.008612, 0.014218, 0.004406, 0.005771, 0.012245, 0.013314, 0.005192, 0.006394, 0.012146, 0.013173, 0.014324, 0.019069, 0.010119, 0.007528, 0.010396, 0.006184, 0.008044, 0.025945, 0.004452, 0.006727, 0.006634, 0.006362, 0.009843, 0.010277, 0.008201, 0.005104, 0.007641, 0.011916, 0.007938, 0.013475, 0.015320, 0.013223, 0.008021, 0.007214, 0.019664, 0.012499, 0.009924, 0.012238, 0.004583, 0.009769, 0.010858, 0.018072, 0.015891, 0.016301, 0.005086, 0.009724, 0.013689, 0.006947, 0.018343, 0.006008, 0.010718, 0.007561, 0.012426, 0.005714, 0.008952, 0.008772, 0.008486, 0.010343, 0.006428, 0.010379, 0.012358, 0.029092, 0.009954, 0.005761, 0.012243, 0.009798, 0.011365, 0.008227, 0.010509, 0.013693, 0.024590, 0.008460, 0.009572, 0.010108, 0.006877, 0.006681, 0.005014, 0.012026, 0.011693, 0.005759, 0.009590, 0.005102, 0.010945, 0.012756, 0.008666, 0.008343, 0.010537, 0.009408, 0.008398, 0.015107, 0.006437, 0.021036, 0.009669, 0.013418, 0.012365, 0.008358, 0.014369, 0.012667, 0.024166, 0.011213, 0.005149, 0.014665, 0.008676, 0.014849, 0.008384, 0.012130, 0.014756, 0.008694, 0.005146, 0.011772, 0.023831, 0.009340, 0.008069, 0.008387, 0.020754, 0.010720, 0.009272, 0.020692, 0.007414, 0.007733, 0.007785, 0.015884, 0.009678, 0.008310, 0.006594, 0.007109, 0.006245, 0.010745, 0.007504, 0.006755, 0.010624, 0.012903, 0.010012, 0.005114, 0.015299, 0.011935, 0.016815, 0.024998, 0.018225, 0.009598, 0.009182, 0.014186, 0.014446, 0.009357, 0.013320, 0.017154, 0.008359, 0.018473, 0.034786, 0.013627, 0.009033, 0.005953, 0.032669, 0.005165, 0.010408, 0.008477, 0.012249, 0.012048, 0.006635, 0.012052, 0.009813, 0.010286, 0.011910, 0.028392, 0.007859, 0.008806, 0.007313, 0.006840, 0.005228, 0.021108, 0.011045, 0.008467, 0.008145, 0.005998, 0.007241, 0.023122, 0.008357, 0.008855, 0.006867, 0.006838, 0.006793, 0.007544, 0.042169, 0.028417, 0.005637, 0.009344, 0.004425, 0.010685, 0.004880, 0.011204, 0.005549, 0.009769, 0.020370, 0.008742, 0.006713, 0.006089, 0.017571, 0.008781, 0.016775, 0.006296, 0.006660, 0.010556, 0.020699, 0.014460, 0.009239, 0.004257, 0.005335, 0.012580, 0.011561, 0.006389, 0.005592, 0.006556, 0.010595, 0.014920, 0.010902, 0.009875, 0.008015, 0.004421, 0.010764, 0.012438, 0.004747, 0.013512, 0.010824, 0.013765, 0.029240, 0.009221, 0.006897, 0.006572, 0.005269, 0.017421, 0.016123, 0.009069, 0.012721, 0.005650, 0.010874, 0.009748, 0.004504, 0.007239, 0.003553, 0.010143, 0.008413, 0.014178, 0.003190, 0.008559, 0.013533, 0.007164, 0.021256, 0.006192, 0.021819, 0.013763, 0.006150, 0.008157, 0.010349, 0.024809, 0.006590, 0.009756, 0.005295, 0.005951, 0.007981, 0.006627, 0.006315, 0.008742, 0.009570, 0.011676, 0.009205, 0.008825, 0.009789, 0.014979, 0.006402, 0.005463, 0.016072, 0.005293, 0.007727, 0.007420, 0.012390, 0.013420, 0.028907, 0.006398, 0.009861, 0.006041, 0.007164, 0.012091, 0.008041, 0.005116, 0.015925, 0.006510, 0.012878, 0.009829, 0.010753, 0.016179, 0.019754, 0.008764, 0.012246, 0.011126, 0.009248, 0.017508, 0.011325, 0.006849, 0.010979, 0.010541, 0.010069, 0.012243, 0.014180, 0.005303, 0.006148, 0.003891, 0.009583, 0.006637, 0.013958, 0.007064, 0.012771, 0.012267, 0.005468, 0.012221, 0.008547, 0.009401, 0.007015, 0.013323, 0.005311, 0.015009, 0.010425, 0.011062, 0.021169, 0.013704, ];
    %dFea = 1024; % reduced by PCA
    
    load('dictionary/feaDatabase_avg.mat');
    feaDatabase = feaDatabase_avg;
    nFea = length(feaDatabase.path);
    
    %feaDatabase = geneTrainIndex_Tpl(feaDatabase);
    
    fprintf('Testing...\n');
    clabel = unique(feaDatabase.label);
    nclass = length(clabel);   
    accuracy = zeros(nRounds, 1 + nclass);
    acc = zeros(nclass, 1);
    
    for ii = 1:nRounds
        fprintf('Round %d...\n', ii);
        
        tr_idx = [];
        ts_idx = [];
        
        for jj = 1:nclass
            idx_label = find(feaDatabase.label == clabel(jj));
            num = length(idx_label);
            
            idx_rand = randperm(num);
            %idx_rand = [1: num];
            tr_num = round(num*2/3);
            if false%jj == 7 || jj == 5 || jj == 4,
                tr_idx = [tr_idx; idx_label(idx_rand(randperm(tr_num, 70)))];
            else
                tr_idx = [tr_idx; idx_label(idx_rand(1:tr_num))];
            end
            ts_idx = [ts_idx; idx_label(idx_rand(tr_num+1:end))];
        end
        
%         if ii == 1
%             tr_idx = feaDatabase.trainlist01;
%             ts_idx = feaDatabase.testlist01;
%         elseif ii == 2
%             tr_idx = feaDatabase.trainlist02;
%             ts_idx = feaDatabase.testlist02;
%         elseif ii == 3
%             tr_idx = feaDatabase.trainlist03;
%             ts_idx = feaDatabase.testlist03;
%         end
        %% train classifier
        fprintf('Training number: %d\n', length(tr_idx));
        fprintf('Testing number:%d\n', length(ts_idx));
            
        tr_fea = zeros(length(tr_idx), dFea);
        tr_label = zeros(length(tr_idx), 1);
            
        for jj = 1:length(tr_idx)
            fpath = feaDatabase.path{tr_idx(jj)};
            load(fpath, 'fea', 'label');
            tr_fea(jj, :) = fea(:) ;
            tr_label(jj) = label;
        end
            
        %options = ['-c ' num2str(para_cost)];
        %options = '-s 0 -c 4'
        options = '-c 1'
        model = train(double(tr_label), sparse(tr_fea), options);
        %clear tr_fea;
        %% train over
            
        %% test begin
            ts_num = length(ts_idx);
            ts_label = [];
            
            ts_fea = zeros(length(ts_idx), dFea);
            ts_label = zeros(length(ts_idx), 1);
            
            for jj = 1:length(ts_idx)
                fpath = feaDatabase.path{ts_idx(jj)};
                load(fpath, 'fea', 'label');
                ts_fea(jj, :) = fea(:);
                ts_label(jj) = label;
            end
%             [C,acc, prob] = predict(tr_label, sparse(tr_fea), model, '-b 1');
%             [C,acc, prob] = predict(ts_label, sparse(ts_fea), model, '-b 1');
            [C,acc, prob] = predict(tr_label, sparse(tr_fea), model);
            [C, overall_acc, ~] = predict(ts_label, sparse(ts_fea), model);
        %%
        %% calculate accuracy
%         for jj = 1:
%         end
       
        for jj = 1:nclass
            c = clabel(jj);
            idx = find(ts_label == c);
            current_pred_label = C(idx);
            current_gnd_label = ts_label(idx);
            acc(jj) = length(find(current_pred_label == current_gnd_label))/length(idx);
        end
        %%
        accuracy(ii, 1) =  (overall_acc(1))*0.01;
        accuracy(ii, 2:end) = acc';
    end
    Ravg = mean(accuracy(:, 1));
    Rstd = std(accuracy(:, 1));
    fprintf('===============================================\n');
    fprintf('Average classification accuracy: %f %f %f %f %f %f %f %f\n',...
        mean(accuracy(:,2)), mean(accuracy(:,3)), mean(accuracy(:,4)), ...
        mean(accuracy(:,5)), mean(accuracy(:,6)), mean(accuracy(:,7)), ...
        mean(accuracy(:,8)), mean(accuracy(:,9)));
    fprintf('MAP %f\n',  Ravg);
    fprintf('Standard deviation:%f %f %f %f %f %f %f %f\n', ...
        std(accuracy(:,2)), std(accuracy(:,3)), std(accuracy(:,4)), ...
        std(accuracy(:,5)), std(accuracy(:,6)), std(accuracy(:,7)), ...
        std(accuracy(:,8)), std(accuracy(:,9)));    
    fprintf('MAstd %f\n',  Rstd);
    fprintf('===============================================\n');
end
    

